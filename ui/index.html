<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VANGUARD - Autonomous Supply Chain</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0e27;
      color: #00ff41;
      font-family: 'Courier New', monospace;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #00ff41;
      text-shadow: 0 0 10px #00ff41;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .sentinel-monitor {
      background: #0f1419;
      border: 2px solid #ffaa00;
      padding: 20px;
      margin-bottom: 20px;
    }

    .sentinel-header {
      font-size: 18px;
      font-weight: bold;
      color: #ffaa00;
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .signal-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .signal-control {
      background: #0a0e27;
      padding: 12px;
      border: 1px solid #444;
    }

    .signal-label {
      color: #aaa;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .signal-value {
      color: #ffaa00;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .signal-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .signal-input input {
      flex: 1;
      background: #0a0e27;
      border: 1px solid #ffaa00;
      color: #ffaa00;
      padding: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .signal-input button {
      background: #ffaa00;
      color: #0a0e27;
      border: none;
      padding: 6px 12px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      cursor: pointer;
      font-weight: bold;
    }

    .trigger-status {
      background: #1a1f2e;
      padding: 12px;
      border-left: 3px solid #ffaa00;
      font-size: 13px;
    }

    .trigger-active {
      border-left-color: #ff4444;
      color: #ff4444;
      font-weight: bold;
    }

    .controls {
      background: #0f1419;
      border: 1px solid #00ff41;
      padding: 20px;
      margin-bottom: 20px;
    }

    button {
      background: #00ff41;
      color: #0a0e27;
      border: none;
      padding: 12px 24px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      cursor: pointer;
      text-transform: uppercase;
      font-weight: bold;
      margin-right: 10px;
    }

    button:hover {
      background: #00cc33;
    }

    button:active {
      transform: translateY(2px);
    }

    input {
      background: #0a0e27;
      border: 1px solid #00ff41;
      color: #00ff41;
      padding: 10px;
      font-family: 'Courier New', monospace;
      margin-right: 10px;
      width: 120px;
    }

    .system-state {
      background: #0f1419;
      border: 2px solid #00ff41;
      padding: 20px;
      margin-bottom: 20px;
    }

    .state-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .state-flow {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .state-node {
      padding: 8px 16px;
      margin: 5px;
      background: #1a1f2e;
      border: 1px solid #444;
      color: #666;
      font-size: 12px;
    }

    .state-node.active {
      background: #00ff41;
      color: #0a0e27;
      border-color: #00ff41;
      font-weight: bold;
      box-shadow: 0 0 10px #00ff41;
    }

    .state-node.completed {
      border-color: #00ff41;
      color: #00ff41;
    }

    .state-node.failure {
      border-color: #ff4444;
      color: #ff4444;
      background: #1a0f0f;
    }

    .state-node.active.failure {
      background: #ff4444;
      color: #0a0e27;
      box-shadow: 0 0 10px #ff4444;
    }

    .state-arrow {
      color: #444;
      margin: 0 5px;
    }

    .state-details {
      font-size: 13px;
      color: #aaa;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: #0f1419;
      border: 1px solid #00ff41;
      padding: 20px;
    }

    .panel h2 {
      color: #00ff41;
      margin-bottom: 15px;
      font-size: 18px;
      text-transform: uppercase;
      border-bottom: 1px solid #00ff41;
      padding-bottom: 8px;
    }

    .status-item {
      margin-bottom: 10px;
      padding: 8px;
      background: #0a0e27;
    }

    .status-label {
      color: #888;
      display: inline-block;
      width: 180px;
    }

    .status-value {
      color: #00ff41;
      font-weight: bold;
    }

    .decision-log {
      background: #0f1419;
      border: 1px solid #00ff41;
      padding: 20px;
      max-height: 800px;
      overflow-y: auto;
    }

    .decision-entry {
      margin-bottom: 25px;
      padding: 20px;
      background: #0a0e27;
      border-left: 3px solid #00ff41;
    }

    .decision-entry.no-action {
      border-left-color: #ffaa00;
    }

    .decision-header {
      font-weight: bold;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .decision-type-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #00ff41;
      color: #0a0e27;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }

    .decision-type-badge.no-action {
      background: #ffaa00;
    }

    .decision-type-badge.failure {
      background: #ff4444;
      color: #0a0e27;
    }

    .decision-entry.failure-entry {
      border-left-color: #ff4444;
      background: #1a0f0f;
    }

    .if-no-action {
      background: #1a0f0f;
      border: 1px solid #ff4444;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }

    .if-no-action-title {
      color: #ff4444;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .no-action-decision {
      background: #1a1a0f;
      border: 1px solid #ffaa00;
      padding: 12px;
      margin: 10px 0;
      font-size: 13px;
    }

    .no-action-title {
      color: #ffaa00;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .severity-breakdown {
      background: #0f1419;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }

    .severity-factor {
      margin: 3px 0;
      color: #aaa;
    }

    .alternatives {
      background: #0f1419;
      padding: 15px;
      margin: 15px 0;
    }

    .alternatives-title {
      color: #00ff41;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .alternative-option {
      margin: 8px 0;
      padding: 8px;
      background: #0a0e27;
      font-size: 13px;
    }

    .option-selected {
      border-left: 3px solid #00ff41;
    }

    .option-rejected {
      border-left: 3px solid #ff4444;
      opacity: 0.7;
    }

    .budget-guardrails {
      background: #0f1a19;
      border: 1px solid #00ff41;
      padding: 12px;
      margin: 10px 0;
      font-size: 13px;
    }

    .guardrail-title {
      color: #00ff41;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .guardrail-item {
      margin: 4px 0;
      color: #aaa;
    }

    .negotiation-attempts {
      background: #0f1419;
      padding: 10px;
      margin: 10px 0;
    }

    .negotiation-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .negotiation-attempt {
      margin: 5px 0;
      padding: 5px;
      font-size: 12px;
    }

    .attempt-failed {
      color: #ff4444;
    }

    .attempt-success {
      color: #00ff41;
    }

    .decision-rationale {
      background: #0f1419;
      padding: 12px;
      margin: 10px 0;
      border-left: 2px solid #00ff41;
      font-size: 13px;
      color: #aaa;
    }

    .post-execution {
      background: #0f1419;
      padding: 12px;
      margin: 10px 0;
      border-left: 2px solid #00aaff;
      font-size: 13px;
      color: #aaa;
    }

    .post-execution-title {
      color: #00aaff;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .decision-chain {
      margin-top: 15px;
    }

    .chain-step {
      margin: 5px 0 5px 15px;
      color: #aaa;
      font-size: 13px;
    }

    .metric {
      display: inline-block;
      margin-right: 20px;
      padding: 5px 10px;
      background: #1a1f2e;
    }

    .metric-label {
      color: #888;
    }

    .metric-value {
      color: #00ff41;
      font-weight: bold;
    }

    .success {
      color: #00ff41;
    }

    .warning {
      color: #ffaa00;
    }

    .error {
      color: #ff4444;
    }

    .loading {
      color: #888;
      font-style: italic;
    }

    .connection-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 10px;
      color: #444;
    }

    .connected {
      color: #00ff41;
    }

    .disconnected {
      color: #ff4444;
    }

    /* ... existing styles ... */

    /* Decision Badges & Tooltips */
    .badge-autonomous {
      background: #00ff41;
      color: #0a0e27;
    }

    .badge-no-action {
      background: #ffaa00;
      color: #0a0e27;
    }

    .badge-failure {
      background: #ff4444;
      color: #0a0e27;
    }

    .tooltip-container {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip-text {
      visibility: hidden;
      width: 250px;
      background-color: #0f1419;
      color: #fff;
      text-align: center;
      border: 1px solid #444;
      padding: 8px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 11px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .tooltip-container:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Phase Timeline Visuals */
    .state-node.skipped {
      border: 2px solid #ffaa00;
      color: #ffaa00;
      background: transparent;
      opacity: 0.8;
    }

    .state-node.blocked {
      border: 2px solid #ff4444;
      color: #ff4444;
      background: transparent;
    }

    .state-node.past {
      opacity: 0.5;
      border-color: #444;
    }

    .state-node.active-pulse {
      background: #00ff41;
      color: #0a0e27;
      box-shadow: 0 0 15px #00ff41;
      animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(0, 255, 65, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
      }
    }

    /* Decision Summary Card */
    .decision-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .decision-main-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .decision-subtitle {
      font-size: 11px;
      color: #888;
      font-style: italic;
    }

    .decision-stats {
      text-align: right;
      font-size: 11px;
      color: #aaa;
    }

    .confidence-legend {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: help;
    }

    .replay-btn {
      background: #1a1f2e;
      border: 1px solid #00ff41;
      color: #00ff41;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      margin-top: 5px;
    }

    .replay-btn:hover {
      background: #00ff41;
      color: #1a1f2e;
    }

    /* Manual Override Disabled */
    .manual-override-disabled {
      background: #333;
      color: #666;
      border: 1px solid #444;
      cursor: not-allowed;
    }

    .manual-override-disabled:hover {
      background: #333;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #0a0e27;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff41;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>‚ö° VANGUARD</h1>
    <div class="subtitle">Self-Healing Sovereign Supply Chain Agents</div>

    <div id="connectionStatus" class="connection-status disconnected">‚óè Disconnected</div>

    <div class="sentinel-monitor">
      <div class="sentinel-header">üîç Continuous Sentinel Monitor</div>
      <div class="signal-controls">
        <div class="signal-control">
          <div class="signal-label">Port Congestion Level</div>
          <div class="signal-value" id="portCongestionDisplay">--</div>
          <div class="signal-input">
            <input type="number" id="portCongestionInput" min="0" max="100" value="42">
            <button onclick="updateSignal('port_congestion', 'portCongestionInput')">Set</button>
          </div>
        </div>
        <div class="signal-control">
          <div class="signal-label">Supplier Reliability Index</div>
          <div class="signal-value" id="supplierReliabilityDisplay">--</div>
          <div class="signal-input">
            <input type="number" id="supplierReliabilityInput" min="0" max="1" step="0.01" value="0.89">
            <button onclick="updateSignal('supplier_reliability', 'supplierReliabilityInput')">Set</button>
          </div>
        </div>
        <div class="signal-control">
          <div class="signal-label">Weather Risk Score</div>
          <div class="signal-value" id="weatherRiskDisplay">--</div>
          <div class="signal-input">
            <input type="number" id="weatherRiskInput" min="0" max="100" value="18">
            <button onclick="updateSignal('weather_risk', 'weatherRiskInput')">Set</button>
          </div>
        </div>
      </div>
      <div id="triggerStatus" class="trigger-status">Monitoring... No threshold breach detected</div>
    </div>

    <div class="controls">
      <input type="text" id="shipmentId" value="SH-4429" placeholder="Shipment ID">
      <input type="number" id="delayHours" value="48" placeholder="Delay (hours)">
      <button onclick="triggerEtaDrift()">Trigger ETA Drift</button>
      <button onclick="refreshStatus()">Force Refresh</button>
      <span id="statusMessage" class="loading"></span>
    </div>

    <div class="system-state">
      <div class="state-header">System State</div>
      <div id="stateFlow" class="state-flow"></div>
      <div id="stateDetails" class="state-details"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Shipment Status</h2>
        <div id="shipmentStatus"></div>
      </div>
      <div class="panel">
        <h2>Financial Status</h2>
        <div id="budgetStatus"></div>
      </div>
    </div>

    <div class="decision-log">
      <h2>Autonomous Decision Trace (No Human Approval)</h2>
      <div id="decisionLog"></div>
    </div>
  </div>

  <!-- Chat Window Overlay -->
  <div id="chatWindow" class="chat-window">
    <div class="chat-header">
      <span>SYSTEM TERMINAL</span>
      <span class="chat-status">‚óè LIVE</span>
    </div>
    <div id="chatContent" class="chat-content">
      <div class="chat-line system-msg">Initializing VANGUARD Network...</div>
      <div class="chat-line system-msg">Connecting to Agent Swarm...</div>
      <div class="chat-line success-msg">Connected. Waiting for triggers.</div>
    </div>
  </div>

  <style>
    /* Chat Window Styles */
    .chat-window {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      height: 480px;
      background: rgba(10, 14, 39, 0.95);
      border: 1px solid #00ff41;
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
      display: flex;
      flex-direction: column;
      font-family: 'Courier New', monospace;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .chat-header {
      background: #0f1419;
      border-bottom: 1px solid #00ff41;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: #00ff41;
      text-transform: uppercase;
      font-size: 14px;
    }

    .chat-status {
      font-size: 10px;
      color: #00ff41;
      animation: blink 2s infinite;
    }

    .chat-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-size: 12px;
      scroll-behavior: smooth;
    }

    .chat-line {
      margin-bottom: 8px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .chat-line.system-msg {
      color: #888;
    }

    .chat-line.success-msg {
      color: #00ff41;
    }

    .chat-line.error-msg {
      color: #ff4444;
    }

    .chat-line.agent-start {
      color: #ffaa00;
      font-weight: bold;
      border-top: 1px solid #333;
      padding-top: 8px;
      margin-top: 8px;
    }

    .chat-line.agent-log {
      color: #ccc;
      padding-left: 10px;
      border-left: 1px solid #444;
    }

    .chat-timestamp {
      color: #555;
      font-size: 10px;
      margin-right: 5px;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* Scrollbar for chat */
    .chat-content::-webkit-scrollbar {
      width: 6px;
    }

    .chat-content::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }

    .chat-group {
      border: 1px solid #333;
      margin-bottom: 10px;
      padding: 5px;
      background: #0d1220;
    }

    .group-header {
      font-size: 11px;
      color: #888;
      border-bottom: 1px solid #333;
      margin-bottom: 5px;
      padding-bottom: 2px;
      text-transform: uppercase;
    }

    .agent-name {
      color: #ffaa00;
      font-weight: bold;
    }
  </style>

  <script>
    const STATE_FLOW = [
      'AT_RISK',
      'ANALYZING',
      'GUARDRAILS_PRECHECK',
      'GENERATING_OPTIONS',
      'GUARDRAILS_POSTCHECK',
      'DECISION_PENDING',
      'NEGOTIATING',
      'EXECUTING',
      'POST_EXECUTION_MONITORING',
      'LOGGING',
      'STABILIZED',
      'NO_VIABLE_SOLUTION'
    ];

    const STATE_LABELS = {
      'AT_RISK': 'At Risk',
      'ANALYZING': 'Analyzing',
      'GUARDRAILS_PRECHECK': 'Guardrails (Pre)',
      'GENERATING_OPTIONS': 'Generating Options',
      'GUARDRAILS_POSTCHECK': 'Guardrails (Post)',
      'DECISION_PENDING': 'Decision Pending',
      'NEGOTIATING': 'Negotiating',
      'EXECUTING': 'Executing',
      'POST_EXECUTION_MONITORING': 'Post-Exec Monitor',
      'LOGGING': 'Logging',
      'STABILIZED': 'Stabilized',
      'MONITORING': 'Monitoring',
      'NO_VIABLE_SOLUTION': 'No Solution',
      'FAILED': 'Failed'
    };

    function formatValue(val) {
      if (val === null || val === undefined || Number.isNaN(val)) return 'UNKNOWN';
      return val;
    }

    // --- SSE Event Listening ---
    const connectionStatus = document.getElementById('connectionStatus');
    let evtSource = null;

    function connectSSE() {
      if (evtSource) evtSource.close();

      evtSource = new EventSource('http://localhost:3000/events');

      evtSource.onopen = () => {
        connectionStatus.innerHTML = '‚óè LIVE (Event-Stream)';
        connectionStatus.className = 'connection-status connected';
        console.log('[SSE] Connected');
      };

      evtSource.onerror = (err) => {
        connectionStatus.innerHTML = '‚óè Reconnecting...';
        connectionStatus.className = 'connection-status disconnected';
        console.error('[SSE] Error', err);
      };

      evtSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const timestamp = data.timestamp ? new Date(data.timestamp) : new Date();
          const timeStr = timestamp.toLocaleTimeString('en-US', { hour12: false });

          if (data.type === 'initial_state' || data.type === 'state_update') {
            displaySystemState(data.state || data);
            refreshStatus();
          } else if (data.type === 'signals_update') {
            displayMonitoredSignals(data.signals);
          } else if (data.type === 'agent_start') {
            logToChat(data.shipmentId, data.agent, `ACTIVATING ${data.agent}...`, 'agent-start', timeStr);
          } else if (data.type === 'agent_log') {
            logToChat(data.shipmentId || 'SYSTEM', data.agent, data.log, 'agent-log', timeStr);
          } else if (data.type === 'agent_end') {
            const color = data.status === 'success' ? 'success-msg' : 'error-msg';
            const msg = data.status === 'success' ? 'COMPLETED' : `FAILED (${data.error || data.status})`;
            logToChat(data.shipmentId, data.agent, msg, color, timeStr);
          }
        } catch (e) {
          console.error('SSE Parse Error:', e);
        }
      };

      // --- FIX 5: GROUPED CHAT ---
      function logToChat(incidentId, agent, message, className = '', timeStr) {
        const chat = document.getElementById('chatContent');

        // 1. Find or Create Group for Incident
        let group = document.getElementById(`group-${incidentId}`);
        if (!group) {
          group = document.createElement('div');
          group.id = `group-${incidentId}`;
          group.className = 'chat-group';
          group.innerHTML = `<div class="group-header">Executing Incident: ${incidentId}</div>`;
          chat.appendChild(group);
        }

        // 2. Append Message to Group
        const line = document.createElement('div');
        line.className = `chat-line ${className}`;
        line.innerHTML = `<span class="chat-timestamp">[${timeStr}]</span> <span class="agent-name">${agent}:</span> ${message}`;

        group.appendChild(line);
        chat.scrollTop = chat.scrollHeight;
      }
    }

    // Initialize SSE
    connectSSE();
    // ----------------------------

    async function updateSignal(signalType, inputId) {
      const value = parseFloat(document.getElementById(inputId).value);
      try {
        await fetch('http://localhost:3000/update-signal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signal_type: signalType, value })
        });
        // refreshStatus(); // No need, SSE will trigger it if server emits events
      } catch (error) {
        console.error('Error updating signal:', error);
      }
    }

    async function triggerEtaDrift() {
      const shipmentId = document.getElementById('shipmentId').value;
      const delayHours = parseInt(document.getElementById('delayHours').value);
      const statusMsg = document.getElementById('statusMessage');

      statusMsg.textContent = 'Triggering ETA drift...';
      statusMsg.className = 'loading';

      try {
        await fetch('http://localhost:3000/trigger-eta-drift', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ shipment_id: shipmentId, delay_hours: delayHours })
        });

        statusMsg.textContent = 'ETA drift triggered - Sentinel monitoring...';
        statusMsg.className = 'warning';

        // SSE will handle the refresh
      } catch (error) {
        statusMsg.textContent = 'Error: ' + error.message;
        statusMsg.className = 'error';
      }
    }

    async function performSentinelCheck() {
      const shipmentId = document.getElementById('shipmentId').value;
      try {
        const response = await fetch(`http://localhost:3000/sentinel-check?shipment_id=${shipmentId}`);
        const result = await response.json();

        const triggerStatus = document.getElementById('triggerStatus');

        if (result.trigger_decision) {
          triggerStatus.className = 'trigger-status trigger-active';
          triggerStatus.textContent = `‚ö† THRESHOLD BREACH DETECTED | Aggregate Risk: ${result.aggregate_risk}% | Trigger: ${result.trigger_threshold}% | ${result.assessment}`;
        } else {
          triggerStatus.className = 'trigger-status';
          triggerStatus.textContent = `Monitoring... Aggregate Risk: ${result.aggregate_risk}% | Threshold: ${result.trigger_threshold}% | Status: Normal`;
        }
      } catch (error) {
        console.error('Sentinel check error:', error);
      }
    }

    async function refreshStatus() {
      try {
        const response = await fetch('http://localhost:3000/status');
        const data = await response.json();

        displayMonitoredSignals(data.monitored_signals);
        displaySystemState(data.system_state);
        displayShipmentStatus(data.shipments);
        displayBudgetStatus(data.budget);
        displayDecisionLog(data.logs);
      } catch (error) {
        console.error('Error fetching status:', error);
      }
    }

    function displayMonitoredSignals(signals) {
      if (!signals) return;
      document.getElementById('portCongestionDisplay').textContent = `${formatValue(signals.port_congestion_level)}%`;
      const rel = signals.supplier_reliability_index;
      document.getElementById('supplierReliabilityDisplay').textContent = rel !== undefined ? rel.toFixed(2) : 'UNKNOWN';
      document.getElementById('weatherRiskDisplay').textContent = `${formatValue(signals.weather_risk_score)}%`;
    }

    function displaySystemState(systemState) {
      const flowContainer = document.getElementById('stateFlow');
      const detailsContainer = document.getElementById('stateDetails');

      // The backend now returns a map of { [shipmentId]: { state, agent, ... } }
      const shipmentId = document.getElementById('shipmentId').value;
      const currentState = systemState[shipmentId];

      if (!currentState) {
        flowContainer.innerHTML = STATE_FLOW.map(state =>
          `<div class="state-node">${STATE_LABELS[state]}</div><span class="state-arrow">‚Üí</span>`
        ).join('');
        detailsContainer.textContent = 'Awaiting sentinel trigger...';
        return;
      }

      // STATE_FLOW is ['AT_RISK', 'ANALYZING', ...]
      const currentIndex = STATE_FLOW.indexOf(currentState.state);

      // Infer Skipped Phases
      const skippedPhases = new Set();
      let skipTooltip = '';

      const ctx = currentState.context || {};
      const decision = ctx.final_decision; // 'NO_ACTION', 'FAILURE', 'INTERVENTION'
      const outcome = ctx.final_log?.decision_outcome;
      const skipReason = ctx.final_log?.skip_reason || ctx.final_log?.system_action || 'Optimization';

      // --- FIX 1: Deriving accurate System State (No "Stabilized" lies) ---
      function deriveSystemState(decisionOutcome) {
        if (!decisionOutcome) return "Monitoring";
        switch (decisionOutcome) {
          case 'INTERVENTION_EXECUTED': return "Stabilized by System";
          case 'NO_ACTION_NO_OPTIONS': return "Unresolved ‚Äî No Viable Actions";
          case 'NO_ACTION_REDUNDANT': return "Resolved Externally (Observed)";
          case 'OBSERVED_ONLY': return "Monitoring Only";
          case 'FAILURE_INTERNAL': return "System Error ‚Äî Intervention Aborted";
          case 'NO_ACTION_GUARDRAIL_BLOCKED': return "Blocked by Guardrails";
          default: return decisionOutcome.replace(/_/g, ' ');
        }
      }

      const realSystemStatus = deriveSystemState(outcome);

      // --- FIX 2: Timeline Logic ---
      // If NO_ACTION or FAILURE, valid next phases (Execution/Monitoring) are SKIPPED, not completed.
      if (decision === 'NO_ACTION' || (decision === 'FAILURE' && currentState.state === 'STABILIZED') || outcome === 'FAILURE_INTERNAL' || outcome === 'NO_ACTION_NO_OPTIONS') {
        skippedPhases.add('EXECUTING');
        skippedPhases.add('POST_EXECUTION_MONITORING');

        if (outcome === 'FAILURE_INTERNAL' || outcome === 'NO_ACTION_NO_OPTIONS') {
          skippedPhases.add('STABILIZED');
        }

        if (decision === 'NO_ACTION' || outcome === 'NO_ACTION_NO_OPTIONS') {
          if (ctx.audit_decision?.action_recommendation === 'NO_ACTION_RECOMMENDED') {
            skippedPhases.add('NEGOTIATING');
          }
          if (outcome === 'NO_ACTION_NO_OPTIONS') {
            skippedPhases.add('NEGOTIATING');
          }
        }
        skipTooltip = `Skipped: ${skipReason}`;
      }

      flowContainer.innerHTML = STATE_FLOW.map((state, index) => {
        let className = 'state-node';
        let tooltipAttr = '';

        // Handling Statuses
        if (state === 'NO_VIABLE_SOLUTION' || state === 'FAILED') {
          className += ' failure';
        }

        if (state === currentState.state) {
          className += ' active active-pulse';
        } else if (skippedPhases.has(state)) {
          className += ' skipped'; // Amber outline
          tooltipAttr = `title="${skipTooltip}"`;
          // Add tooltip container logic if needed, or simple title
        } else if (currentIndex > -1 && index < currentIndex) {
          className += ' completed past'; // Dimmed
        }

        const arrow = index < STATE_FLOW.length - 1 ? '<span class="state-arrow">‚Üí</span>' : '';

        // Wrap in tooltip container if skipped
        if (skippedPhases.has(state)) {
          return `<div class="tooltip-container">
                        <div class="${className}">${STATE_LABELS[state]}</div>
                        <span class="tooltip-text">${skipTooltip}</span>
                    </div>${arrow}`;
        }

        return `<div class="${className}" ${tooltipAttr}>${STATE_LABELS[state]}</div>${arrow}`;
      }).join('');

      let detailText = `System Status: ${realSystemStatus}`;

      // Explicit activeAgent update
      if (currentState.agent) {
        detailText += ` | Active Agent: ${currentState.agent}`;
      }

      detailText += ` | Last Updated: ${new Date(currentState.timestamp || currentState.lastUpdated).toLocaleTimeString()}`;

      detailsContainer.textContent = detailText;
    }

    function displayShipmentStatus(shipments) {
      const container = document.getElementById('shipmentStatus');
      const shipment = Object.values(shipments)[0];

      if (!shipment) {
        container.innerHTML = '<div class="loading">No shipment data</div>';
        return;
      }

      container.innerHTML = `
        <div class="status-item">
          <span class="status-label">Shipment ID:</span>
          <span class="status-value">${shipment.shipment_id}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Status:</span>
          <span class="status-value ${shipment.status === 'rerouted' ? 'warning' : 'success'}">${shipment.status.toUpperCase()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Origin:</span>
          <span class="status-value">${shipment.origin}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Destination:</span>
          <span class="status-value">${shipment.destination}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Current ETA:</span>
          <span class="status-value">${new Date(shipment.current_eta).toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">SLA Deadline:</span>
          <span class="status-value">${new Date(shipment.sla_deadline).toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Supplier:</span>
          <span class="status-value">${shipment.supplier_id}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Carrier:</span>
          <span class="status-value">${shipment.carrier}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Value:</span>
          <span class="status-value">$${shipment.value.toLocaleString()}</span>
        </div>
      `;
    }

    function displayBudgetStatus(budget) {
      const container = document.getElementById('budgetStatus');

      container.innerHTML = `
        <div class="status-item">
          <span class="status-label">Total Budget:</span>
          <span class="status-value">$${budget.total_budget.toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Emergency Reserve:</span>
          <span class="status-value">$${budget.emergency_reserve.toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Available:</span>
          <span class="status-value ${budget.available < budget.emergency_reserve * 0.5 ? 'warning' : 'success'}">$${budget.available.toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Allocated:</span>
          <span class="status-value">$${budget.allocated.toLocaleString()}</span>
        </div>
        <div class="status-item">
          <span class="status-label">Transactions:</span>
          <span class="status-value">${budget.transactions.length}</span>
        </div>
      `;

      if (budget.transactions.length > 0) {
        const lastTx = budget.transactions[budget.transactions.length - 1];
        container.innerHTML += `
          <div class="status-item" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #00ff41;">
            <div class="status-label" style="display: block; margin-bottom: 5px;">Last Transaction:</div>
            <div style="font-size: 12px; color: #aaa;">
              ${lastTx.transaction_id}<br>
              Amount: <span class="status-value">$${lastTx.amount.toLocaleString()}</span><br>
              Destination:
${lastTx.destination}<br>
              Time: ${new Date(lastTx.timestamp).toLocaleString()}
            </div>
          </div>
        `;
      }
    }

    function displayDecisionLog(logs) {
      const container = document.getElementById('decisionLog');

      if (!logs || logs.length === 0) {
        container.innerHTML = '<div class="loading">No decisions logged yet</div>';
        return;
      }

      // Deduplication Logic
      const uniqueIncidents = new Map();
      logs.forEach(log => {
        const key = log.full_trace?.signal?.shipment_id || log.incident_id || log.shipment_id;
        if (key) uniqueIncidents.set(key, log);
      });

      const reversedLogs = Array.from(uniqueIncidents.values()).reverse();

      container.innerHTML = reversedLogs.map(log => {
        // --- 3-AXIS MAPPING ---
        const outcome = log.decision_outcome || log.decision_type; // Fallback
        const reality = log.incident_reality || 'ACTIVE';
        const guardrail = log.guardrail_result || 'ALLOWED';
        const systemAction = log.system_action || (outcome === 'INTERVENTION_EXECUTED' ? 'Intervention Executed' : outcome);

        // Badge Logic
        let badgeClass = 'badge-autonomous'; // Default Green
        let outcomeLabel = outcome.replace(/_/g, ' ');
        let outcomeSubtitle = '';

        if (outcome === 'INTERVENTION_EXECUTED') {
          badgeClass = 'badge-autonomous';
          outcomeLabel = 'AUTONOMOUS INTERVENTION';
          outcomeSubtitle = 'System executed mitigation. Impact validated.';
        } else if (outcome.startsWith('NO_ACTION')) {
          badgeClass = 'badge-no-action';

          // FIX 3: Specific Banner
          if (outcome === 'NO_ACTION_NO_OPTIONS') {
            outcomeLabel = 'NO ACTION ‚Äî OPTIMIZATION SPACE EXHAUSTED';
            outcomeSubtitle = 'All candidate interventions violated constraints (Budget/SLA/Risk).';
          } else if (outcome === 'NO_ACTION_REDUNDANT') {
            outcomeLabel = 'NO ACTION ‚Äî REDUNDANT';
            outcomeSubtitle = 'Skipped: Incident already resolved (Idempotent).';
          } else if (outcome === 'NO_ACTION_GUARDRAIL_BLOCKED') {
            outcomeLabel = 'NO ACTION ‚Äî BLOCKED';
            outcomeSubtitle = 'Blocked by Guardrails (Policy/Safety).';
          } else {
            outcomeLabel = 'NO ACTION';
            outcomeSubtitle = 'System skipped execution.';
          }
          badgeClass = 'badge-no-action'; // Or distinct Blue? Let's use Amber for "No Action" family but maybe distinct style
          outcomeLabel = 'OBSERVED (STABLE)';
          outcomeSubtitle = 'Monitoring only. No intervention warranted.';
        } else if (outcome === 'FAILURE_INTERNAL') {
          badgeClass = 'badge-failure';
          outcomeLabel = 'SYSTEM FAILURE';
          outcomeSubtitle = 'Internal system error during processing.';
        }

        const allOptions = log.full_trace?.options?.options || log.full_trace?.negotiator?.all_options || [];
        const optionsCountText = `${allOptions.length} ${allOptions.length === 0 ? '(None generated)' : '(Analyzed)'}`;

        // Impact Text
        let impactText = log.counterfactual_impact || 'N/A';
        if (impactText === 'N/A') {
          if (outcome === 'INTERVENTION_EXECUTED') impactText = `Net Save: $${(log.net_save || 0).toLocaleString()}`;
          else if (outcome === 'NO_ACTION_REDUNDANT') impactText = 'Prevented duplicate spend';
          else if (outcome === 'OBSERVED_ONLY') impactText = 'Baseline maintained';
        }

        // Options Visualization
        let optionsHtml = '';
        if (allOptions.length > 0) {
          optionsHtml = `<div class="alternatives">
                <div class="alternatives-title">OPTIONS EVALUATED</div>
                ${allOptions.map(opt => {
            let icon = '[ ]';
            let statusClass = '';
            let statusText = '';

            // Check selection logic
            const isSelected = log.full_trace?.negotiator?.selected_option?.option_id === opt.option_id;

            if (isSelected && outcome === 'INTERVENTION_EXECUTED') {
              icon = '[‚úì]';
              statusClass = 'option-selected';
              statusText = '| <strong>SELECTED</strong>';
            } else if (opt.rejectionReason || !opt.withinBudget) { // Simplified check
              icon = '[x]';
              statusClass = 'option-rejected';
              statusText = `| REJECTED (${opt.rejectionReason || 'Constraints'})`;
            } else {
              statusText = '| Pass (Not Selected)';
            }

            return `
                        <div class="alternative-option ${statusClass}">
                            ${icon} <strong>${opt.type}</strong> 
                            | Cost: $${opt.estimated_cost?.toLocaleString() || 'N/A'} 
                            | SLA: ${opt.delivery_hours}h 
                            ${statusText}
                        </div>
                    `;
          }).join('')}
            </div>`;
        } else if (outcome !== 'OBSERVED_ONLY') {
          // If observed only, we don't expect options. If action/no_action, we might report "No options"
          optionsHtml = `<div class="if-no-action">No options generated.</div>`;
        }

        // Confidence Color
        const confidence = log.confidence || 0;
        const confColor = confidence >= 0.9 ? '#00ff41' : (confidence >= 0.7 ? '#ffaa00' : '#ff4444');

        return `
          <div class="decision-entry ${outcome.startsWith('NO_ACTION') || outcome === 'OBSERVED_ONLY' ? 'no-action' : ''} ${outcome === 'FAILURE_INTERNAL' ? 'failure-entry' : ''}">
             
             <!-- Decision Summary Header -->
             <div class="decision-summary-header">
                <div class="decision-main-info">
                    <span class="decision-type-badge ${badgeClass}" style="margin-left:0;">${outcomeLabel}</span>
                    <span class="decision-subtitle">${outcomeSubtitle}</span>
                </div>
                <div class="decision-stats">
                    <div style="font-weight:bold; color: #fff;">${systemAction}</div>
                    <div style="font-size:10px; color:#666;">Guardrail: ${guardrail}</div>
                    <div style="margin-top:4px;">Impact: ${impactText}</div>
                </div>
             </div>

             <!-- Details -->
             <div class="decision-rationale">
                <strong>Incident Reality:</strong> ${reality}<br>
                <strong>Analysis ID:</strong> ${log.incident_id.split('-').pop()}<br>
                
                <div class="confidence-legend">
                    Confidence: <span style="color: ${confColor}">${(confidence * 100).toFixed(0)}%</span>
                     | Options: ${optionsCountText}
                </div>
             </div>
             
             <!-- Replay (Mock) -->
             <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="replay-btn" title="Replays the recorded decision logic. Does not re-execute actions.">Replay Context</button>
             </div>

             <div>${(log.decision_chain || []).map(step => `<div class="chain-step">‚Ä∫ ${step}</div>`).join('')}</div>
             
             ${optionsHtml}
             
             <div style="font-size:10px; color:#444; margin-top:10px; text-align:right;">
                Stable ‚Ä¢ Audit Logged: ${new Date(log.timestamp).toLocaleTimeString()}
             </div>
          </div>
        `;
      }).join('');
    }

    refreshStatus();
    // Removed polling setInterval(refreshStatus, 1000);
    setInterval(performSentinelCheck, 3000); // Keep sentinel monitoring as it drives the Monitor panel data
  </script>
</body>

</html>